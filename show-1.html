
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link rel="stylesheet" type="text/css" href="/assets/css/main.css">
<link rel="stylesheet" type="text/css" href="/assets/css/index.css">
<link rel="stylesheet" type="text/css" href="/assets/css/menu.css">

<link rel="stylesheet" media="screen"
	href="/assets/css/handsontable.full.css">
<link rel="stylesheet" media="screen" href="/assets/css/b.css">
<link rel="stylesheet" media="screen" href="/assets/css/jquery-ui.css">
<style type="text/css">
.readonly {
	color: red;
}

.warp {
	WORD-WRAP: break-word;
}
</style>
<title>项目显示</title>
</head>
<body background="#f7f8fa">
	<div class="body-container">
		<div class="top-banner">
			<div class="logo"></div>
			<div class="spliter"></div>
			<div class="date">1</div>
			<div class="user"></div>
			<div class="spliter"></div>
			<div class="logout">
				<a href="logout.php">登出</a>
			</div>
			<div class="spliter"></div>
			<div class="change"><a >修改密码</a></div>
		</div>
		<div class="middle">
			<div class="span-left add-project">
				<!--				<div class="new-project-btn">
					<p>+&nbsp;新建项目</p>
				</div>-->
			</div>
			<div class="span-right project-title">
				<p>中共成都市青羊区组织部目标信息管理系统,欢迎您回来</p>
			</div>
		</div>
		<div class="main">
			<div class="span-left show-project year"></div>
			<div class="span-right" id="text-main">
				<div id="tbl-main"></div>
			</div>

			<div class="bottom-bar">
				<ul>

					<li id='save' class="disable">保存</li>
					<li id='exportxls'>导出</li>
					<!--<li id='attach'>添加附件</li>
					
					<li id='show'>查看</li> 
					<li id='addcol'>添加列</li>
					<li id='addrow'>添加行</li>
					<li id='delcol'>删除列</li>
					<li id='delrow'>删除行</li> -->
				</ul>
			</div>
<!-- 			<div class="left attach-bar">
				<ul>
					<li class="doc">
						<p>测试文档</p> <a href="/upload/tmp/身份证证面-2015-03-26.png">下载</a>
						<div class="cross"></div>
					</li>
				</ul>
			</div> -->
		</div>
	</div>
	<div id="dialog-confirm" title="有未保存项:"></div>
	<div class="new-project">
		<p class="np-title">新建项目</p>
		<textarea class="np-name" placeholder="项目名称"></textarea>
		<div class="np-date">
			<select class="np-year">
				<option opid=0>年份</option>
			</select>
			<div class="np-line">
				<select class="np-month">
					<option>月份</option>
				</select> <select class="np-day">
					<option>日期</option>
				</select>
			</div>
			<div class="np-btn np-ok">
				<p>确认</p>
			</div>
			<div class="np-btn np-cancel">
				<p>取消</p>
			</div>
		</div>
		<!-- 		<div class="np-name edit" placeholder="项目名称"></div> -->
	</div>
	<div class="del-project">
		<p class="dp-title">删除</p>
		<p class="dp-info"></p>
		<div class="np-btn dp-ok">
			<p>确认</p>
		</div>
		<div class="np-btn dp-cancel">
			<p>取消</p>
		</div>
	</div>
	<div class="leave">
		<p class="l-title">删除</p>
		<p class="l-info">有未保存项是否离开当前页?</p>
		<div class="np-btn l-ok">
			<p>确认</p>
		</div>
		<div class="np-btn l-cancel">
			<p>取消</p>
		</div>
	</div>
	<!-- 		<div class="np-name edit" placeholder="项目名称"></div> -->
	<div class="comments">
		<p class="c-title">设置我的完成情况</p>
		<textarea rows="" cols=""></textarea>
		<p class="c-submit">提交</p>
	</div>
	<div class="attach">
		<p class="a-title">添加附件</p>
		<div class="a-info">
			<ul>

			</ul>
			<ul>
				<li class="a-add">+ 添加</li>
			</ul>
		</div>
		<div class="np-btn a-ok">
			<p>确认</p>
		</div>
		<div class="np-btn a-cancel">
			<p>取消</p>
		</div>
	</div>
	
	<div class="attach-show">
		<p class="as-title">查看附件</p>
		<div class="as-info">
			<div class=" attach-bar">
				<ul>
					<li class="doc">
						<p>测试文档</p> <a href="/upload/tmp/身份证证面-2015-03-26.png">下载</a>
						<div class="cross"></div>
					</li>
					<li class="doc">
						<p>测试文档</p> <a href="/upload/tmp/身份证证面-2015-03-26.png">下载</a>
						<div class="cross"></div>
					</li>
					<li class="doc">
						<p>测试文档</p> <a href="/upload/tmp/身份证证面-2015-03-26.png">下载</a>
						<div class="cross"></div>
					</li>
					<li class="doc">
						<p>测试文档</p> <a href="/upload/tmp/身份证证面-2015-03-26.png">下载</a>
						<div class="cross"></div>
					</li>
					<li class="doc">
						<p>测试文档</p> <a href="/upload/tmp/身份证证面-2015-03-26.png">下载</a>
						<div class="cross"></div>
					</li>
					<li class="doc">
						<p>测试文档</p> <a href="/upload/tmp/身份证证面-2015-03-26.png">下载</a>
						<div class="cross"></div>
					</li>
					<li class="doc">
						<p>测试文档</p> <a href="/upload/tmp/身份证证面-2015-03-26.png">下载</a>
						<div class="cross"></div>
					</li>
				</ul>
			</div>
		</div>

		<div class="np-btn as-cancel">
			<p>关闭</p>
		</div>
	</div>
	
	<div class="pwd-change">
		<p class="pc-title">密码修改</p>
		<p class="pc-info"><input type="text" id='change-pwd' class="default" default_text="新密码"></p>
			
			<div class="np-btn pc-ok"><p>确认</p></div>
			<div class="np-btn pc-cancel"><p>取消</p></div>
	</div>
	<div id="mask" class="mask" style="display: none;"></div>
	<div id="tip" class="tip-info"></div>
</body>
<script type="text/javascript" src="/assets/js/jquery-1.8.1.min.js"></script>
<script type="text/javascript" src="/assets/js/md5-min.js"></script>
<script type="text/javascript" src="/assets/js/admin.js"></script>
<script type="text/javascript" src="/assets/js/public.js"></script>
<script type="text/javascript" src="/assets/js/menu.js"></script>
<script type="text/javascript" src="/assets/js/project.js"></script>
<script type="text/javascript" src="/assets/js/handsontable.full.js"></script>
<script type="text/javascript" src="/assets/js/jquery-ui.js"></script>
<script type="text/javascript" src="assets/js/attach.js"></script>
<script type="text/javascript" src="assets/js/ajaxfileupload.js"></script>
<script type="text/javascript">
	$(function() {
		var name = "";
		var tbl = null;
		var jsondata = null;
		var id = $.public.get('id');
		var uid = -1;		
		var load =false; //标记是否读取完成
		var projectName = "";
		$('.tt').live("hover", function(event) {
			if ($(this).html().indexOf("...") > 0) {
				if (event.type == 'mouseenter') {
					var X = $(this).offset().top + $(this).height();
					var Y = $(this).offset().left + $(this).width();
					//alert($(this).offset().top + '---' + $(this).offset().left + '---' +$(this).height()+ '---' +$(this).width());
					//alert(X+"=="+Y);
					$.public.tip(true, $(this).attr('data'), Y, X);
				} else {
					$.public.tip(false);
				}
			}
		});
		
		$('.attach  .a-ok').click(function() {		
			var arr = Array();
			var attid = 1;
			$('.file-box input[type=file]').each(function(){
/* 				var id = 1;
				if($(this).val()!=""){
					//arr.push($(this).attr('id'));
				} */
	
				if($(this).val()!=""){
					arr.push('fileToUpload' + attid);
				}
				attid++;
			});
					
			$.ajaxFileUpload
			(
				{
					url:'action/doajaxfileupload.php',
					secureuri:false,
					fileElementId:arr,
					dataType: 'json',
					data:{num:id, id:'fileToUpload',pjname:projectName},
					success: function (data, status)
					{
						if(typeof(data.error) != 'undefined')
						{
							if(data.error != '')
							{
								alert(data.error);
							}
						}						
						location.reload();	
						$.attach.attachAreaClear();
						$('.attach').hide();
						$.public.mask(false);
					},
					error: function (data, status, e)
					{
						//alert(e);
						$.attach.attachAreaClear();
						$('.attach').hide();
						$.public.mask(false);
					}
				}
			);			
		});
		

		
		$('.attach  .a-cancel').click(function() {
			$.attach.getAllAttach(id,function(data){
				$.attach.reload(data);		
			});
			$.attach.attachAreaClear();
			$('.attach').hide();
			$.public.mask(false);
		});
		
		$('.attach-bar ul li').live("hover", function(event){			
			if(event.type=='mouseenter'){
				if($(this).attr('owner') == uid)
					$(this).find('.cross').show();
			}else{
				if($(this).attr('owner') == uid)
					$(this).find('.cross').hide();
			} 			
		});

		$('.attach-bar .cross').live("click",function(){
			var atid =$(this).parent('li').attr('atid');
			$.attach.delAttach(atid,function(){
				$.attach.getAttach(id,projectName,function(data){
					$.attach.reload(data);		
				});	
			});
		});
		
		
		function del_project(obj) {
			$('.del-project .dp-info').html('确认删除:<br>' + obj.find('p').html());
			$('.del-project .dp-info').attr('attrid', obj.attr('attrid'));
			$('.del-project').show();
			$.public.mask(true);
			//		if(window.confirm("确认删除?")== true)
			//			alert(obj.attr('attrid'));
		}
		function edit_project(obj) {
			//window.location.href = '/show-1.html?id=' + obj.attr('attrid');

		}
		var n_attrid = -1;
		function click_project(obj) {

			if (obj.find('.tt').attr('contentEditable') == 'true')
				return;
			if($('#save').hasClass('disable'))
			{
				window.location.href = '/show-1.html?id=' + obj.attr('attrid');				
			}
			else
			{
				n_attrid = obj.attr('attrid');
				$('.leave').show();
				$.public.mask(true);
			}
		}
		
		$('.leave .l-ok').click(function(){
			if(n_attrid != -1)
				window.location.href = '/show.html?id=' + n_attrid;
		});
		
		$('.leave .l-cancel').click(function(){
			$('.leave').hide();
			$.public.mask(false);
		});
		
		function select_function(obj) {
			//obj.find('.tt').css('color', 'white');
			//obj.find('.select').css('display', 'block');
			obj.parent('ul').parent('.submenu').parent('.item-list').find(
					'.np-list-name').click();
		}
		$('.comments #close').live("click", function() {
			$('.comments').hide();
			$.public.mask(false);
		});
		
		function getMyComment(str)
		{
			if(str==null)
				return "";
			var commentsList = new Array();
			commentsList = str.split("\n");
			for (i = 0; i < commentsList.length; i++) {
				//alert(commentsList[i]);
				var element = new Array();
				element = commentsList[i].split(":");
				if (element[0] == name)
					return element[1];
			}
			return "";
		}
		var g_commentRow =-1;
		var g_commentCol =-1;
		$('.attach-show .as-cancel').click(function(){
			location.reload();	
			$('.attach-show').hide();
			$.public.mask(false);
		});
		function showAttach(row){
			
			var head = tbl.getData()[0];
			var data = tbl.getData()[row];
			var pjCol = -1;
			var personCol = -1;
			for ( var i in head) {
				if (head[i] == '责任人')
					personCol = i;
				if (head[i] == '项目')
					pjCol = i;
			}
			
			if( pjCol == -1 || personCol == -1)
			{
				alert('表格有错误');
				return;
			}
			
			projectName = data[pjCol];
			//alert(projectName);
			
			$('.attach-show').show();
			$.public.mask(true);
			$.attach.getAttach(id,projectName,function(data){
				$.attach.reload(data);		
			});
		}
		
		function setAttach(row) {
			var head = tbl.getData()[0];
			var data = tbl.getData()[row];
			var pjCol = -1;
			var personCol = -1;
			var commentCol = -1;
			var mycomment = "";
			for ( var i in head) {
				if (head[i] == '责任人')
					personCol = i;
				if (head[i] == '项目')
					pjCol = i;
				if (head[i] == '完成情况')
					commentCol = i;
			}
			
			if( pjCol == -1 || personCol == -1
					|| commentCol == 1)
			{
				alert('表格有错误');
				return;
			}
			
			projectName = data[pjCol];
			//alert(projectName);
			
			selectUser = data[personCol];
			var userstrs = new Array();
			userstrs = selectUser.split("\n");
			for (i = 0; i < userstrs.length; i++) {
				if (userstrs[i] != "") {
					if (name == userstrs[i]) {
						g_commentRow = row;
						g_commentCol = commentCol;
						 $('.attach').show();
						  $.public.mask(true);
						return;
					}

				}
			}
			alert('你不是当前责任人.');
		}
		
		function setSelect(row) {
			var head = tbl.getData()[0];
			var data = tbl.getData()[row];
			var unitCol = -1;
			var personCol = -1;
			var commentCol = -1;
			var mycomment = "";
			for ( var i in head) {
				if (head[i] == '责任人')
					personCol = i;
				if (head[i] == '责任科室')
					unitCol = i;
				if (head[i] == '完成情况')
					commentCol = i;
			}
			
			if( unitCol == -1 || personCol == -1
					|| commentCol == 1)
			{
				alert('表格有错误');
				return;
			}
			mycomment = getMyComment(data[commentCol]);
			$('.comments textarea').val(mycomment);
			selectUnit = data[unitCol];
			selectUser = data[personCol];
			var userstrs = new Array();
			userstrs = selectUser.split("\n");
			for (i = 0; i < userstrs.length; i++) {
				if (userstrs[i] != "") {
					if (name == userstrs[i]) {
						g_commentRow = row;
						g_commentCol = commentCol;
						$('.comments').show();
						$.public.mask(true);
						return;
					}

				}
			}
			alert('你不是当前责任人.');
		}
		$('.comments .c-submit').click(function(){
			if(g_commentCol != -1 && g_commentRow != -1)
			{
				var str = tbl.getData()[g_commentRow][g_commentCol];				
				var commentsList = new Array();
				var newStr = "";
				var find = false;
				var newComment = $('.comments textarea').val();
				//去掉换行符
				newComment = newComment.replace(/\n/ig,"");	
				
				if(str != null){
					commentsList = str.split("\n");
					for (i = 0; i < commentsList.length; i++) {
						
						var element = new Array();			
						if(commentsList[i] != ""){
							element = commentsList[i].split(":");
							newStr += element[0]+":";
							if (element[0] == name){
								find = true;			
								newStr += newComment+"\n";
							}
							else
								newStr+=element[1]+"\n";
						}
					}
				}
				if(find == false)
					newStr += name+":"+newComment+"\n";
				
				tbl.setDataAtCell(parseInt(g_commentRow), parseInt(g_commentCol), newStr);
				$('#save').removeClass('disable');
			}
			$('.comments').hide();
			$.public.mask(false);			
		});
		
		$('#show').click(function() {
			alert(JSON.stringify(tbl.getData())); //returns all cells' data
		});
		$('#save').click(function() {
			if ($(this).hasClass('disable'))
				return;
			//alert(id); //returns all cells' data
			$.project.savetbl(id, JSON.stringify(tbl.getData()));
			$('#save').addClass('disable');
		})

		$('#exportxls').click(function() {
			window.location.href = './down-xls.php?id=' + id;
		});
		function tbl_onload() {
			var main = document.getElementById('tbl-main');

			function textWarp(instance, td, row, col, prop, value,
					cellProperties) {
				Handsontable.renderers.TextRenderer.apply(this, arguments);
				td.className = 'warp'; //add class "negative"
				var meta = instance.getCellMeta(row, col);
				if (meta.readOnly) {
					td.className += ' readonly';
				}
			}
			tbl = new Handsontable(main, {
				data : jsondata,
				colWidths : [ 80, 100, 100, 100 ],
				manualColumnResize : true,
				manualRowResize : true,
				rowHeaders : true,
				colHeaders : true,
				minSpareRows : 1,
				persistentState : true,
				contextMenu : true,
				contextMenu : {
					callback : function(key, options) {
						if (key === 'set_finish') {
							//alert(this.getSelected()[0]);
							setSelect(this.getSelected()[0]);
						}

						if (key === 'add_attach') {
							setAttach(this.getSelected()[0])							
						}
						if (key === 'show_attach') {
							showAttach(this.getSelected()[0]);
						}

					},
					items : {
						"set_finish" : {
							name : '设置完成信息'
						},
						"add_attach" : {
							name : '添加附件'
						},
						"show_attach" : {
							name : '查看附件'
						},
					}
				},
				cells : function(row, col, prop) {
					var cellProperties = {};

					cellProperties.readOnly = true; //make cell read-only if it is first row or the text reads 'readOnly'

					cellProperties.renderer = textWarp; //uses lookup map

					return cellProperties;
				},
				beforeRemoveCol : function(index, amount) {
					var name = this.getData()[0][index];
					if (fixColCheck(name) == true) {
						alert("固定列不允许删除");
						return false;
					}

				},
				afterLoadData :function(){
					console.log('afterLoadData');

					
				},
				afterInit:function(){
					load =true;	
				}
			});
		}
		function onload(json) {
			//alert(json[0].t_projectName);
			//alert(JSON.stringify(json));
			$('.project-title').find('p').html(json[0].t_projectName);
			//var text = json[0].t_tables.replace(/\'/g,'"');
			//alert(text);
			jsondata = eval(json[0].t_tables);
			tbl_onload();
		}
		
		/* {
			"t_pkId":"43",
			"url":"/upload/tmp/552e60ba96e22.rtf",
			"fk_projectId":"18",
			"name":"修改.rtf",
			"fk_user":"27",
			"fk_projectname":"项目2",
			"t_name":"管理员"
		} */
		
		// 附件的处理开始
		var attaches = null;
		function clearAttach(tb)
		{
			
			for(var i in tb)
			{
				var line = tbl.getData()[i];
				if(i > 0)
				{
					for(var j in line)
					{
						if(tbl.getDataAtCell(0, j) ==  "附件")
						{
							console.log('i='+i+':j='+j);
							tbl.setDataAtCell(parseInt(i), parseInt(j), "");
						}
					}
				}				
			}
		}
		function addAttach(tb, data)
		{			
			var projectIndex = -1;
			var attachIndex = -1;
			var attachContent = false;
			//alert(JSON.stringify(data));
			for(var i in tb)
			{
				var line = tbl.getData()[i];
				if(i == 0)
				{
					for(var j in line)
					{
						if(line[j] == "项目")
						{
							projectIndex = j;							
						}
						if(line[j] == "附件")
						{
							attachIndex = j;							
						}
					}
					continue;
				}
				if(projectIndex == -1 || attachIndex == -1)
				{
					alert("表格错误 找不到 项目|附件 列;");
					return;
				}
				
				if(line[0] == null)
					break;				
				
				if(data.fk_projectname == line[projectIndex])
				{
					
					attachContent = tbl.getDataAtCell(i, attachIndex);
					if(attachContent == null)
						attachContent ="";
					attachContent += data.t_name+":"+data.name+"\n";
					tbl.setDataAtCell (parseInt(i), parseInt(attachIndex), attachContent);
				}
				
				//alert(JSON.stringify(line));
				//alert(JSON.stringify(data[i]));
			}
			
			
		}
		
		// 附件的处理结束
		var time = 0;
		var func;
		function wait_recursive()
		{
			if(load == false){
				console.log("wait "+time);
				setTimeout( wait_recursive, time);
			}
			else{
				console.log("wait finish");
				func();
			}
		}
		function wait(msec, success_func)
		{
			time = msec;
			func = success_func;
			
			wait_recursive();
			
			
		}
		
		
		function on_finish(obj) {
			$.project.get(id, onload);
			$.public.mask(true);
			wait(500,function(){
				console.log("getAllAttach");
				$.attach.getAllAttach(id,function(data){
					attaches = data;
					var tb = tbl.getData();
					//alert(JSON.stringify(data));
					clearAttach(tb);
					for(var i in data)
					{
						addAttach(tb, data[i]);
						//alert(JSON.stringify(data[i]));
					}
					
					//老方案
					//$.attach.reload(data);		
				});
				$.public.mask(false);
			});
			
			

		}
		$.public.getUser(function(json) {
			name = json['t_name'];
			uid = json['pk_id'];
		});
		
		$.menu.menuInit($('.show-project'), id, select_function, on_finish);
		$.menu.bind(del_project, edit_project, click_project);
		
		
		
		
	});
</script>
</html>